<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>EmpowerFresh Sprint Insights</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #f9f9f9;
        padding: 2rem;
        max-width: 600px;
        margin: auto;
        color: #222;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        text-align: center;
      }

      .form-grid {
        display: grid;
        gap: 1rem;
      }

      label {
        display: flex;
        flex-direction: column;
        font-weight: 600;
      }

      select {
        padding: 0.5rem;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: white;
      }

      button {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        border: none;
        border-radius: 6px;
        background: #2563eb;
        color: white;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      button:hover {
        background: #1e40af;
      }
    </style>
  </head>
  <body>
    <h1>üìä EmpowerFresh Sprint Insights</h1>

    <div class="form-grid">
      <label>
        Time Period:
        <select id="range">
          <option value="sprint-to-today">üïì This Sprint (to Today)</option>
          <option value="full-sprint">üìÖ This Sprint (Full 2 Weeks)</option>
          <option value="prev-sprint">‚¨ÖÔ∏è Previous Sprint (Full 2 Weeks)</option>
          <option value="1M">üìÜ Last 1 Month</option>
          <option value="3M">üìÜ Last 3 Months</option>
          <option value="max">üìä All Time</option>
        </select>
      </label>

      <label>
        Metric:
        <select id="metric">
          <option value="20">Ticket Count</option>
          <option value="18">Story Points</option>
        </select>
      </label>

      <label>
        Label:
        <select id="label">
          <option value="">‚Äî None ‚Äî</option>
          <option value="sev-1">
            sev-1 ‚Äì Service is completely down for all customers
          </option>
          <option value="sev-2">
            sev-2 ‚Äì Service is down for a subset of customers
          </option>
          <option value="sev-3">sev-3 ‚Äì Partial loss of functionality</option>
          <option value="sev-4">
            sev-4 ‚Äì Minor issue not affecting core functionality
          </option>
          <option value="Shrink Reporting">Shrink Reporting</option>
          <option value="sp-1">sp-1 ‚Äì Tech Debt</option>
          <option value="test">test</option>
          <option value="Triage">
            Triage ‚Äì Needs prioritization and assignment
          </option>
          <option value="Vend: A&L Potato">Vend: A&amp;L Potato</option>
          <option value="Vend: Affiliated">Vend: Affiliated</option>
          <option value="Vend: AWG">Vend: AWG</option>
          <option value="Vend: Four Seasons">Vend: Four Seasons</option>
          <option value="Vend: Liberty Fruit">Vend: Liberty Fruit</option>
          <option value="Vend: Quality Fruit & Veg">
            Vend: Quality Fruit &amp; Veg
          </option>
          <option value="Vend: Russ Davis">Vend: Russ Davis</option>
          <option value="Vend: TMK">Vend: TMK</option>
          <option value="Vend: UNFI">Vend: UNFI</option>
          <option value="Vend: Yate's">Vend: Yate's</option>
          <option value="After Deployment">After Deployment</option>
          <option value="AppTeam">AppTeam</option>
          <option value="BLOCKED">
            BLOCKED ‚Äì Status is blocked for some reason
          </option>
          <option value="Bug">Bug ‚Äì Something isn't working</option>
          <option value="Cust: B&R">Cust: B&amp;R</option>
          <option value="Cust: C&R">Cust: C&amp;R</option>
          <option value="Cust: Hugo's">Cust: Hugo's</option>
          <option value="Cust: Karns">Cust: Karns</option>
          <option value="Cust: Kirby">Cust: Kirby</option>
          <option value="Cust: Lowe's">Cust: Lowe's</option>
          <option value="Cust: McCaffrey's">Cust: McCaffrey's</option>
          <option value="Cust: Nafiehs">Cust: Nafiehs</option>
          <option value="Cust: Pruett's">Cust: Pruett's</option>
          <option value="Cust: Queen's">Cust: Queen's</option>
          <option value="Cust: Ray's">Cust: Ray's</option>
          <option value="Cust: White's">Cust: White's</option>
          <option value="Customer Scorecard">
            Customer Scorecard ‚Äì Dashboard
          </option>
          <option value="Deployment">Deployment</option>
          <option value="Discovery needed">Discovery needed</option>
          <option value="Docs">Docs ‚Äì Documentation improvements</option>
          <option value="eFresh">
            eFresh ‚Äì Effort for deploying the order guide
          </option>
          <option value="Epic">Epic ‚Äì Large body of work</option>
          <option value="Feature">
            Feature ‚Äì New features or enhancements
          </option>
          <option value="Frontend">Frontend</option>
          <option value="Investigation">Investigation</option>
          <option value="Needs Refinement">Needs Refinement</option>
          <option value="Onboarding">
            Onboarding ‚Äì New customer/vendor setup
          </option>
          <option value="Platform & Data Team">Platform &amp; Data Team</option>
          <option value="priority-low">priority-low</option>
        </select>
      </label>

      <label>
        Assignee:
        <select id="assignee">
          <option value="">‚Äî None ‚Äî</option>
          <option value="btemple-ef">btemple-ef</option>
          <option value="cwymore">cwymore</option>
          <option value="Jawa-Enkhjin">Jawa-Enkhjin</option>
          <option value="Isaachristian">Isaachristian</option>
          <option value="zac-ef">zac-ef</option>
        </select>
      </label>

      <button onclick="go()">Go</button>
      <div style="margin-top: 1rem">
        <label
          for="preview-link"
          style="font-weight: bold; display: block; margin-bottom: 0.25rem"
        >
          üìé Copy GitHub Chart Link
        </label>
        <div style="display: flex; gap: 0.5rem">
          <input
            type="text"
            id="preview-link"
            readonly
            style="flex: 1; padding: 0.5rem; font-size: 0.9rem"
          />
          <button
            type="button"
            onclick="copyLink()"
            style="
              padding: 0.5rem 0.75rem;
              font-size: 0.9rem;
              background: #2563eb;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
            "
          >
            üìã Copy
          </button>
        </div>
        <p
          id="copy-status"
          style="
            color: green;
            margin-top: 0.25rem;
            min-height: 1.25rem;
            transition: opacity 0.2s ease;
          "
        ></p>
      </div>
    </div>

    <script>
      const expectedPassword = "efinsights";

      window.addEventListener("DOMContentLoaded", () => {
        const preview = document.getElementById("preview-link");

        function updatePreview() {
          preview.value = buildShareableURL();
        }

        // Initial fill
        updatePreview();

        // Update preview when any select changes
        ["range", "metric", "label", "assignee"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("change", updatePreview);
        });

        // If user is already authed from sessionStorage, update preview on load
        if (sessionStorage.getItem("authenticated") === "true") {
          updatePreview();
        }
      });

      function buildShareableURL() {
        const metric = document.getElementById("metric")?.value || "20";
        const range = document.getElementById("range")?.value;
        const label = document.getElementById("label")?.value.trim();
        const assignee = document.getElementById("assignee")?.value.trim();
        const today = new Date();
        const baseline = new Date("2025-05-20");
        const MS_IN_DAY = 86400000;

        const filters = ["is:issue"];
        let start = null;
        let end = null;
        let period = "";

        // Handle sprint ranges
        if (["sprint-to-today", "full-sprint", "prev-sprint"].includes(range)) {
          const isPrev = range === "prev-sprint";
          const sprintLabel = isPrev ? "@previous" : "@current";
          filters.push(`sprint:${sprintLabel}`);

          let sprintStart = getSprintStart(today, baseline);
          if (isPrev)
            sprintStart = new Date(sprintStart.getTime() - 14 * MS_IN_DAY);

          start = sprintStart;
          end =
            range === "sprint-to-today"
              ? today
              : new Date(sprintStart.getTime() + 13 * MS_IN_DAY);

          period = `period=custom&start_date=${formatDate(
            start
          )}&end_date=${formatDate(end)}`;
        } else {
          period = `period=${range}`;
        }

        // Always wrap label in quotes
        if (label) {
          filters.push(`label:"${label}"`);
        }

        if (assignee) {
          filters.push(`assignee:${assignee}`);
        }

        const filterQuery = `filterQuery=${encodeURIComponent(
          filters.join(" ")
        )}`;
        const githubBase = `https://github.com/orgs/EmpowerFreshDev/projects/1/insights/${metric}`;
        return `${githubBase}?${filterQuery}&${period}`;
      }

      function copyLink() {
        const fullURL = buildShareableURL();
        const preview = document.getElementById("preview-link");
        const status = document.getElementById("copy-status");

        preview.value = fullURL;

        navigator.clipboard
          .writeText(fullURL)
          .then(() => {
            status.textContent = "‚úÖ Link copied to clipboard!";
            status.style.opacity = 1;

            setTimeout(() => {
              status.style.opacity = 0;
            }, 2500);
          })
          .catch(err => {
            console.error(err);
            status.textContent = "‚ùå Failed to copy link.";
            status.style.opacity = 1;
          });
      }

      function getSprintStart(today, base) {
        const MS_IN_DAY = 86400000;
        const daysSinceBase = Math.floor((today - base) / MS_IN_DAY);
        const offset = Math.floor(daysSinceBase / 14) * 14;
        return new Date(base.getTime() + offset * MS_IN_DAY);
      }

      function formatDate(d) {
        return d.toISOString().split("T")[0];
      }

      function go() {
        const range = document.getElementById("range").value;
        const metric = document.getElementById("metric").value;
        const label = document.getElementById("label").value.trim();
        const assignee = document.getElementById("assignee").value.trim();
        const today = new Date();
        const baseline = new Date("2025-05-20");
        const MS_IN_DAY = 86400000;
        const filters = ["is:issue"];
        let start = null;
        let end = null;
        let periodParam = "";
        let sprintLabel = null;

        if (
          range === "sprint-to-today" ||
          range === "full-sprint" ||
          range === "prev-sprint"
        ) {
          const isPrev = range === "prev-sprint";
          sprintLabel = isPrev ? "@previous" : "@current";

          let sprintStart = getSprintStart(today, baseline);
          if (isPrev)
            sprintStart = new Date(sprintStart.getTime() - 14 * MS_IN_DAY);

          start = sprintStart;
          end =
            range === "sprint-to-today"
              ? today
              : new Date(sprintStart.getTime() + 13 * MS_IN_DAY);

          periodParam = `period=custom`;
          filters.push(`sprint:${sprintLabel}`);
        } else {
          periodParam = `period=${range}`;
        }
        
        if (label) {
          filters.push(`label:"${label}"`);
        }

        if (assignee) filters.push(`assignee:${assignee}`);

        const base = `https://github.com/orgs/EmpowerFreshDev/projects/1/insights/${metric}`;
        let url = base;

        if (filters.length > 0) {
          url += `?filterQuery=${encodeURIComponent(filters.join(" "))}`;
        }

        const delimiter = filters.length > 0 ? "&" : "?";
        if (periodParam) {
          url += `${delimiter}${periodParam}`;
        }

        if (start && end) {
          url += `&start_date=${formatDate(start)}&end_date=${formatDate(end)}`;
        }

        window.open(url, "_blank");
      }
      
      // Handle URL parameters and authentication
      const params = new URLSearchParams(window.location.search);

      // Auto-fill dropdowns
      const prefillFields = ["range", "metric", "label", "assignee"];
      prefillFields.forEach(id => {
        const el = document.getElementById(id);
        const val = params.get(id);
        if (el && val) el.value = val;
      });

      // Auth handling
      const urlPass = params.get("pass");
      const isAuthed = sessionStorage.getItem("authenticated") === "true";

      if (!isAuthed) {
        if (urlPass === expectedPassword) {
          sessionStorage.setItem("authenticated", "true");
          window.history.replaceState(
            {},
            document.title,
            window.location.pathname
          ); // clean URL
        } else {
          const input = prompt("Enter password:");
          if (input !== expectedPassword) {
            document.body.innerHTML =
              '<h2 style="text-align:center;margin-top:5rem;">üîí Access Denied</h2>';
            throw new Error("Not authenticated");
          } else {
            sessionStorage.setItem("authenticated", "true");
          }
        }
      }
    </script>
  </body>
</html>